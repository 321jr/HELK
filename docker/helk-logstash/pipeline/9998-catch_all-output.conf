# HELK Catchall for unparsed logs, critical parse failure logs that could be destructive to database, and additional future usage for simple outputs
# HELK build Stage: Alpha
# Author: Nate Guagenti (@neu5ron)
# License: GPL-3.0


output {

    if [@metadata][helk_input_source] == "mitre_attack" or [@metadata][kafka][topic] == "SYSMON_JOIN" or [source] == "/var/log/osquery/osqueryd.results.log" {
      # MITRE ATT&CK CSV #TODO: Eventually these need redone
      if [@metadata][helk_input_source] == "mitre_attack" {
        elasticsearch {
          hosts => ["helk-elasticsearch:9200"]
          index => "mitre-attack-%{+YYYY.MM}"
          user => 'elastic'
          #password => 'elasticpassword'
        }
      }
      # SYSMON JOIN #TODO: Eventually these need redone
      else if [@metadata][kafka][topic] == "SYSMON_JOIN" {
        elasticsearch {
          hosts => ["helk-elasticsearch:9200"]
          index => "sysmon-join-%{+YYYY.MM.dd}"
          user => 'elastic'
          #password => 'elasticpassword'
        }
      }
      # OS Query #TODO: Eventually these need redone
      else if [source] == "/var/log/osquery/osqueryd.results.log" {
        elasticsearch {
          hosts => ["helk-elasticsearch:9200"]
          index => "logs-endpoint-osquery-%{+YYYY.MM.dd}"
          document_id => "%{[@metadata][log_hash]}"
          user => 'elastic'     
          #password => 'elasticpassword'
        }
      }
  }

  # Regular logs and NO critical errors in parsing
  else if [@metadata][parse-failure] != "yes" {

    # Windows/Winevent/WEF
    if [event_log_type] == "winevent" and [@metadata][helk_parsed] == "yes" {
      # big indexes like security, powershell, application, system
      #if [@metadata][index_name] {
      #  elasticsearch {
      #    hosts => ["helk-elasticsearch:9200"]
      #    #index => "logs-endpoint-winevent-%{[@metadata][index_name]}-%{+YYYY.MM.dd}"
      #    document_id => "%{[@metadata][log_hash]}"
      #    user => 'elastic'
      #    #password => 'elasticpassword'
      #  }
      #}
      if [@metadata][index_name] == "security" {
        elasticsearch {
          hosts => ["helk-elasticsearch:9200"]
          ilm_rollover_alias => "logs-endpoint-winevent-security"
          ilm_enabled => "true"
          ilm_pattern => "0000000001"
          ilm_policy => "ilm_policy_logs_all"
          document_id => "%{[@metadata][log_hash]}"
          user => 'elastic'
          #password => 'elasticpassword'
        }
      }
      else if [@metadata][index_name] == "powershell" {
        elasticsearch {
          hosts => ["helk-elasticsearch:9200"]
          ilm_rollover_alias => "logs-endpoint-winevent-powershell"
          ilm_enabled => "true"
          ilm_pattern => "0000000001"
          ilm_policy => "ilm_policy_logs_all"
          document_id => "%{[@metadata][log_hash]}"
          user => 'elastic'
          #password => 'elasticpassword'
        }
      }
      else if [@metadata][index_name] == "application" {
        elasticsearch {
          hosts => ["helk-elasticsearch:9200"]
          ilm_rollover_alias => "logs-endpoint-winevent-application"
          ilm_enabled => "true"
          ilm_pattern => "0000000001"
          ilm_policy => "ilm_policy_logs_all"
          document_id => "%{[@metadata][log_hash]}"
          user => 'elastic'
          #password => 'elasticpassword'
        }
      }
      else if [@metadata][index_name] == "system" {
        elasticsearch {
          hosts => ["helk-elasticsearch:9200"]
          ilm_rollover_alias => "logs-endpoint-winevent-system"
          ilm_enabled => "true"
          ilm_pattern => "0000000001"
          ilm_policy => "ilm_policy_logs_all"
          document_id => "%{[@metadata][log_hash]}"
          user => 'elastic'
          #password => 'elasticpassword'
        }
      }
      # Silk ETW
      else if [log_name] == "SilkService-Log" {
        elasticsearch {
          hosts => ["helk-elasticsearch:9200"]
          #index => "logs-endpoint-winevent-etw-%{+YYYY.MM.dd}"
          ilm_rollover_alias => "logs-endpoint-winevent-etw"
          ilm_enabled => "true"
          ilm_pattern => "0000000001"
          ilm_policy => "ilm_policy_logs_all"
          document_id => "%{[@metadata][log_hash]}"
          user => 'elastic'
          #password => 'elasticpassword'
        }
      }
      # the rest of windows logs
      else  {
        elasticsearch {
          hosts => ["helk-elasticsearch:9200"]
          #index => "logs-endpoint-winevent-additional-%{+YYYY.MM.dd}"
          ilm_rollover_alias => "logs-endpoint-winevent-additional"
          ilm_enabled => "true"
          ilm_pattern => "0000000001"
          ilm_policy => "ilm_policy_logs_all"
          document_id => "%{[@metadata][log_hash]}"
          user => 'elastic'
          #password => 'elasticpassword'
        }
      }
    }

    # Zeek/Corelight
    if [event_log_type] == "zeek" {
      # '[@metadata][index_name]' gets set in '3102-zeek_corelight-all-log_category.conf'
      elasticsearch {
        hosts => ["helk-elasticsearch:9200"]
        #index => "%{[@metadata][index_name]}-%{+YYYY.MM.dd}"
        ilm_rollover_alias => "logs-network-zeek"
        ilm_enabled => "true"
        ilm_pattern => "0000000001"
        ilm_policy => "ilm_policy_logs_all"
        #document_id => "%{[@metadata][log_hash]}"
        user => 'elastic'
        #password => 'elasticpassword'
      }
    }

    # Unparsed syslog
    else if [@metadata][helk_parsed] != "yes" and [etl_input_application_name] =~ "^syslog" {
      elasticsearch {
        hosts => ["helk-elasticsearch:9200"]
        index => "indexme-syslog-%{etl_input_port}-%{+YYYY.MM.dd}"
        document_id => "%{[@metadata][log_hash]}"
        user => 'elastic'
        #password => 'elasticpassword'
      }
    }

    # Not in schema yet or unknown log
    else if [@metadata][helk_parsed] != "yes" {
        elasticsearch {
          hosts => ["helk-elasticsearch:9200"]
          index => "indexme-%{+YYYY.MM.dd}"
          # document_id => "%{[@metadata][log_hash]}"
          user => 'elastic'
          #password => 'elasticpassword'
        }
    }

  }

  # Critical parse failure or something completely unknown
  else {
    elasticsearch {
      hosts => ["helk-elasticsearch:9200"]
      index => "parse-failures-%{+YYYY.MM.dd}"
      # document_id => "%{[@metadata][log_hash]}"
      user => 'elastic'
      #password => 'elasticpassword'
    }
  }

}
